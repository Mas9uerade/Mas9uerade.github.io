# 十分钟搭建基于 Wordpress 的 Serverless Web 应用

更新时间：2020-02-13 10:43:13

  

本页目录

- [前言](https://help.aliyun.com/document_detail/146729.html#h1-u524Du8A001)
- [1.1 DEMO 概述](https://help.aliyun.com/document_detail/146729.html#h2-1-1-demo-1)
- [1.2 解决方案](https://help.aliyun.com/document_detail/146729.html#h2-1-2-2)
- [1.3 Serverless 方案与传统自建 web 方案对比](https://help.aliyun.com/document_detail/146729.html#h2-1-3-serverless-web-3)
- [函数计算运行 PHP 框架原理](https://help.aliyun.com/document_detail/146729.html#h1--php-2)
- [2.1 传统服务器 PHP 运行原理](https://help.aliyun.com/document_detail/146729.html#h2-2-1-php-4)
- [2.2 FC 驱动 PHP 工程原理](https://help.aliyun.com/document_detail/146729.html#h2-2-2-fc-php-5)
- [案例操作步骤](https://help.aliyun.com/document_detail/146729.html#h1-u6848u4F8Bu64CDu4F5Cu6B65u9AA43)
- [准备条件](https://help.aliyun.com/document_detail/146729.html#h2-u51C6u5907u6761u4EF66)
- [3.1 安装最新的 Fun 工具](https://help.aliyun.com/document_detail/146729.html#h2-3-1-fun-7)
- [3.2 Clone 工程](https://help.aliyun.com/document_detail/146729.html#h2-3-2-clone-8)
- [3.3 根据需要使用的数据库进入不同的目录](https://help.aliyun.com/document_detail/146729.html#h2-3-3-9)
- [3.4 部署函数到FC平台](https://help.aliyun.com/document_detail/146729.html#h2-3-4-fc-10)
- [FAQ](https://help.aliyun.com/document_detail/146729.html#h1-faq4)

# 前言

本文旨在通过 **快速部署一个 Wordpress ** **网站到阿里云 [函数计算](https://help.aliyun.com/product/50980.html?spm=a2c4g.11186623.2.25.25734dfbCxJtFQ) 平台** **。修改1:缺少句号** 这个示例来展示 serverless web 新的开发模式, 包括 FUN 工具一键初始化 NAS, 同步网站到 NAS, 一键部署等能力， 展现函数计算的开发敏捷特性、自动弹性伸缩能力、免运维和完善的监控设施。

相关参考文档： [https://yq.aliyun.com/articles/640912](https://yq.aliyun.com/articles/640912?spm=a2c4g.11186623.2.26.25734dfbCxJtFQ)

## 1.1 DEMO 概述

- DEMO 示例效果入口: [http://hz.mofangdegisn.cn](http://hz.mofangdegisn.cn/?spm=a2c4g.11186623.2.27.25734dfbCxJtFQ)
  - 账号： fc-test-user
  - 密码： fc-test-pwd
- DEMO 示例工程地址: [fc-wordpress](https://github.com/awesome-fc/fc-wordpress?spm=a2c4g.11186623.2.28.25734dfbCxJtFQ)

**开通服务**

[免费开通函数计算](https://statistics.functioncompute.com/?spm=a2c4g.11186623.2.29.25734dfbCxJtFQ&title=ServerlessWordpress&theme=ServerlessWeb&author=rsong&src=article&url=http://fc.console.aliyun.com)， 按量付费，函数计算有很大的免费额度。

[免费开通文件存储服务NAS](https://nas.console.aliyun.com/?spm=a2c4g.11186623.2.30.25734dfbCxJtFQ)， 按量付费 **。修改2：缺少句号**

## 1.2 解决方案

[![image](https://yqfile.alicdn.com/aa24a63302dfac74a54fbada4b273361bf5d179b.png)](https://yqfile.alicdn.com/aa24a63302dfac74a54fbada4b273361bf5d179b.png)

如上图所示， 当多个用户通过对外提供的 url 访问web服务的时候，每秒的请求几百上千都没有关系， 函数计算平台会自动伸缩， 提供足够的执行实例来响应用户的请求， 同时函数计算提供了完善的监控设施来监控您的函数运行情况。

## 1.3 Serverless 方案与传统自建 web 方案对比

| ITEM           | 成本                                            | 稳定性                                                       |
| :------------- | :---------------------------------------------- | :----------------------------------------------------------- |
| 基于 VM 方案   | 使用 ecs.t5-lc1m1.small, 22.8元/月              | 服务器和数据库在同一台VM, 均无主备容灾，同时该规格的主机本身性能弱 |
| 轻量应用服务器 | 60元/月(1vCPU 1GB 1Mbps 20GB[ssd])              | 服务器和数据库在同一台VM, 均无主备容灾，同时该规格的主机本身性能弱 |
| 函数计算       | sqlite3 版本约为 1元/月  mysql 版本大约 26元/月 | 高                                                           |

函数计算完整费用详情：

- 每月前 100 万次函数调用免费， 每月前 400000(GB*秒) 费用免费， 函数的内存可以设置为 128M 或者 256M, 因此对于一个一个月访问量低于 100 万次的网站， 该项是免费的
- 对于低成本的网站， 假设一个月的产生的公网流量为 1GB, 0.8元
- NAS, US$0.06/GB/Month, 网站大小为 50M， 即使按 1G 计算， 0.42元
- RDS mysql 最基本的单机版本， 25元/月

[函数计算计费](https://help.aliyun.com/document_detail/137980.html?spm=a2c4g.11186623.2.32.25734dfbCxJtFQ) | [NAS 定价](https://www.alibabacloud.com/zh/product/nas/pricing?spm=a2c4g.11186623.2.33.25734dfbCxJtFQ)

如上所述， 在低成本网站领域， 函数计算具有十分明显的成本优势，同时还保持了弹性能力，以后业务规模做大以后并没有技术切换成本（可能需要做的只是更换一个更强的关系型数据库), 同时财务成本增长配合预付费也能保持平滑。低成本网站变成高可用高性能网站如丝般顺滑， 高性能网站详情可以参考文末 [FAQ](https://help.aliyun.com/document_detail/146729.html#faq) 中的 Q1 问题。

# 函数计算运行 PHP 框架原理

在具体操作部署之前， 先简单梳理一遍函数计算运行 PHP 框架原理

## 2.1 传统服务器 PHP 运行原理

- 原理示意图[![image.png](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/732e92e40562708356353ce5e3bca844.png)](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/732e92e40562708356353ce5e3bca844.png)

- A simple nginx conf[![image.png](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/6a7b8d30248da69d769b57cc55628d9a.png)](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/6a7b8d30248da69d769b57cc55628d9a.png)

  从上面原理示意图我们可以看出，Web 服务器根据 conf 中 location将 PHP 脚本交给 php-fpm 去解析，然后将解析后的结果返回给 client 端

## 2.2 FC 驱动 PHP 工程原理

[![image](https://yqfile.alicdn.com/9ba22559dbe485c6ab2d39ab86f511c2383d97eb.png)](https://yqfile.alicdn.com/9ba22559dbe485c6ab2d39ab86f511c2383d97eb.png)

- 函数计算的执行环境实例相当于传统 web 服务的 Apache/Nginx

- 用户函数相当于实现 Apache/Nginx 的 conf 中 location

- 用户将 Web 网站部署在 NAS，然后挂载 NAS 到函数的执行环境， 比如下面代码中 `/mnt/auto` 目录

- 对于 WordPress 入口函数代码就是这么简单: [index.php](https://github.com/awesome-fc/fc-wordpress/blob/master/fc-web-sqlite/index.php?spm=a2c4g.11186623.2.38.25734dfbCxJtFQ)

  其中函数计算为用户提供了一个 `$GLOBALS['fcPhpCgiProxy']` 对象用来和 php-fpm 进行交互，对PHP 工程中的 php 文件进行解析，该对象提供了两个重要的接口:

  - requestPhpCgi

    ```
       requestPhpCgi($request, $docRoot, $phpFile = "index.php", $fastCgiParams = [], $options = [])
    ```

    - `$request`: 跟 `php http invoke` 入口的参数一致
    - `$docRoot`: Web 工程的根目录
    - `$phpFile`: 用于拼接 cgi 参数中的 SCRIPT_FILENAME 的默认参数
    - `$fastCgiParams`: 函数计算内部尽量根据 $request给您构造 `default cgi params`, 但是如果您不是想要的，可以使用`$fastCgiParams`覆盖一些参数 (reference: [cgi](https://en.wikipedia.org/wiki/Common_Gateway_Interface?spm=a2c4g.11186623.2.39.25734dfbCxJtFQ))
    - `$options`: array类型，可选参数， debug_show_cgi_params 设为 true ，会打印每次请求 php 解析时候的 cgi 参数， 默认为 false ；readWriteTimeout 设置解析的时间， 默认为 5 秒

如果您有兴趣， 可以了解下函数计算 PHP Runtime:

- [PHP 入口函数](https://help.aliyun.com/document_detail/89029.html?spm=a2c4g.11186623.2.40.25734dfbCxJtFQ)
- [PHP 执行环境](https://help.aliyun.com/document_detail/89032.html?spm=a2c4g.11186623.2.41.25734dfbCxJtFQ)

# 案例操作步骤

## 准备条件

[免费开通函数计算](https://statistics.functioncompute.com/?spm=a2c4g.11186623.2.42.25734dfbCxJtFQ&title=ServerlessWordpress&theme=ServerlessWeb&author=rsong&src=article&url=http://fc.console.aliyun.com)， 按量付费，函数计算有很大的免费额度。

[免费开通文件存储服务NAS](https://nas.console.aliyun.com/?spm=a2c4g.11186623.2.43.25734dfbCxJtFQ)， 按量付费

有一个域名， 比如 abc.com， 并将域名 CNAME 解析到函数计算(FC) 对应的 region

> 如您想在杭州的 region 部署 wordpres 网站， 则将 abc.com CNAME 解析到 12345.cn-hangzhou.fc.aliyuncs.com, 其中 12345 是您的 accountId

## 3.1 安装最新的 Fun 工具

- 安装版本为8.x 最新版或者10.x 、12.x [nodejs](https://nodejs.org/en/download/package-manager/?spm=a2c4g.11186623.2.44.25734dfbCxJtFQ#debian-and-ubuntu-based-linux-distributions-enterprise-linux-fedora-and-snap-packages)
- 安装 [funcraf](https://github.com/alibaba/funcraft/blob/master/docs/usage/installation-zh.md?spm=a2c4g.11186623.2.45.25734dfbCxJtFQ&file=installation-zh.md)

## 3.2 Clone 工程

```
git clone https://github.com/awesome-fc/fc-wordpress.git
```

## 3.3 根据需要使用的数据库进入不同的目录

- 复制 .env_example 文件为 .env, 并且修改 .env 中的信息为自己的信息

  > 如果使用 mysql 数据库, 参考章节 3.3.1
  >
  > 如果使用 sqlite3 数据库, 参考章节 3.3.2 

### 3.3.1 使用 mysql 数据库

- 进入目录 fc-wp-mysql

  ```
    fun nas init  fun nas info
  ```

  > fun nas init: 初始化 NAS, 基于您的 .env 中的信息获取(已有满足条件的nas)或创建一个同region可用的nas
  >
  > 如果你没有修改 templata.yml 中的配置 service名字， 那么则可以进入下一步； 如果有修改， 会在当前目录生成新的目录 .fun/nas/auto-default/{serviceName} (fun nas info 可以列出新的目录), 将默认目录下的 .fun/nas/auto-default/fc-wp-mysql/wordpress 的wordpress目录拷贝到 .fun/nas/auto-default/{serviceName} 下， 同时可以删除目录 .fun/nas/auto-default/fc-wp-mysql/wordpress

- 上传 wordpress 网站到 NAS

  ```
    fun nas sync  fun nas ls nas:///mnt/auto/
  ```

  > `fun nas sync`: 将本地 NAS 中的内容（.fun/nas/auto-default/fc-wp-mysql）上传到 NAS 中的 fc-wp-mysql 目录
  >
  > `fun nas ls nas:///mnt/auto/`: 查看我们是否已经正确将文件上传到了 NAS

### 3.3.2 使用 sqlite3 数据库

- 进入目录 fc-wp-sqlite

  ```
    fun nas init  fun nas info
  ```

  > fun nas init: 初始化 NAS, 基于您的 .env 中的信息获取(已有满足条件的nas)或创建一个同region可用的nas
  >
  > 如果你没有修改 templata.yml 中的配置 service名字， 那么则可以进入下一步； 如果有修改， 会在当前目录生成新的目录 .fun/nas/auto-default/{serviceName} (fun nas info 可以列出新的目录), 将默认目录下的 .fun/nas/auto-default/fc-wp-sqlite/wordpress 的wordpress目录拷贝到 .fun/nas/auto-default/{serviceName} 下， 同时可以删除目录 .fun/nas/auto-default/fc-wp-sqlite/wordpress

- 本地完成安装过程， 初始化 sqlite3 数据库

  - 在目录 .fun/nas/auto-default/fc-wp-sqlite/wordpress 中输入命令：

    ```
    php -S 0.0.0.0:80
    ```

  - 修改 host 文件，添加 `127.0.0.1 hz.mofangdegisn.cn`

    > - linux/mac : vim /etc/hosts 
    > - windows7: C:\Windows\System32\drivers\etc
    >
    > 其中 hz.mofangdegisn.cn 是您预先准备的域名

  - 通过浏览器输入 hz.mofangdegisn.cn， 这个时候没有mysql数据库设置页面，完成 wordpress 安装过程

  > 成功安装以后， 这个时候， .fun/nas/auto-default/fc-wp-sqlite/wordpress/wp-content 下面应该有一个 database 的目录， ls -a 查看， 应该有 .ht.sqlite 这个 sqlite3 数据库文件

  - 回退 host 文件的修改

    注: 中间修改 host 的目的是初始化 sqlite3 数据库的时候， base site url 是提前准备的域名， 而不是 127.0.0.1

- 上传 wordpress 网站到 NAS

  ```
    fun nas sync  fun nas ls nas:///mnt/auto/
  ```

  > `fun nas sync`: 将本地 NAS 中的内容（.fun/nas/auto-default/fc-wp-sqlite）上传到 NAS 中的 fc-wp-sqlite 目录
  >
  > `fun nas ls nas:///mnt/auto/`: 查看我们是否已经正确将文件上传到了 NAS

## 3.4 部署函数到FC平台

接下来将函数部署到云平台：

- 修改 index.php 中的 $host 中的值
- 修改 template.yml LogConfig 中的 Project, 任意取一个不会重复的名字即可
- 修改 template.yml 自定义域名为自己提前准备好的域名
- 执行 `fun deploy`

登录控制台 [https://fc.console.aliyun.com](https://fc.console.aliyun.com/?spm=a2c4g.11186623.2.46.25734dfbCxJtFQ)，可以看到service 和函数已经创建成功， 并且 service 也已经正确配置。

通过浏览器打开自己之前配置的域名， 比如本例中的 hz.mofangdegisn.cn

- mysql 版本数据库， 可以直接跟传统的 wordpress 一样，直接进入安装过程
- sqlite3 版本数据库， 由于之前已经完成初始化，可以直接进入网站首页或网站后台



# FAQ

### Q1: 函数计算能开发高性能高可用网站吗？

A: 可以, 使用函数计算的单实例多并发功能和高性能数据库

- [单实例多并发](https://help.aliyun.com/document_detail/144586.html?spm=a2c4g.11186623.2.47.25734dfbCxJtFQ)
- 选择高性能关系型数据库，比如高可用的[云数据库PolarDB](https://help.aliyun.com/product/58609.html?spm=a2c4g.11186623.2.48.25734dfbCxJtFQ)

有必要再加上这些优化:

- [预留实例消除冷启动](https://help.aliyun.com/document_detail/140338.html?spm=a2c4g.11186623.2.49.25734dfbCxJtFQ) + [预付费优化成本](https://help.aliyun.com/document_detail/138831.html?spm=a2c4g.11186623.2.50.25734dfbCxJtFQ)
- [极速型 NAS](https://www.aliyun.com/product/nas?spm=a2c4g.11186623.2.51.25734dfbCxJtFQ)
- OSS 对象存储 + CDN 来存储和分发静态资源

> 目前 PHP Runtime 并不支持单实例多并发, 使用 Custom Runtime，可以将基于传统模式 nginx + php-fpm + mysql 开发的网站直接简单无缝迁移到函数计算平台，示例工程 [customruntime-php](https://github.com/awesome-fc/customruntime-php?spm=a2c4g.11186623.2.52.25734dfbCxJtFQ)
>
> [使用OSS对Wordpress进行图片动静分离](https://yq.aliyun.com/articles/2996?spm=a2c4g.11186623.2.53.25734dfbCxJtFQ)

### Q2: 使用低成本 sqlite3 版本的网站， 冷启动第一次打开很慢怎么办？

A: 用一个 timer trigger 的函数 keep warm 

### Q3: 使用低成本 sqlite3 版本的网站， 能支持多大的qps？

A: 由 sqlite3 数据库性能决定， 这边有一些压测结果：

[![image](https://yqfile.alicdn.com/1042a8c81e78fa690e7cbc7f17431be9750ca2b6.png)](https://yqfile.alicdn.com/1042a8c81e78fa690e7cbc7f17431be9750ca2b6.png)

[![image](https://yqfile.alicdn.com/55efd81ee20d5133fd82c6a5401037bb836ff0ee.png)](https://yqfile.alicdn.com/55efd81ee20d5133fd82c6a5401037bb836ff0ee.png)

每次压力增大时候， 都有些冷启动，时间慢点，但是支持从压测结果来看支持 50 QPS 是没有疑问的， 是足够支持一些中小网站的。

### Q4: 使用其他语言基于函数计算开发 serverless 网站可以吗？

A: 可以， 比如 python: [https://yq.aliyun.com/articles/603249](https://yq.aliyun.com/articles/603249?spm=a2c4g.11186623.2.56.25734dfbCxJtFQ) , 或者直接使用 custom runtime， 内置了 java、python 和 node, [Custom Runtime 用户手册](https://help.aliyun.com/document_detail/132044.html?spm=a2c4g.11186623.2.57.25734dfbCxJtFQ) , [Custom Runtime 使用集锦](https://yq.aliyun.com/articles/728321?spm=a2c4g.11186623.2.58.25734dfbCxJtFQ)